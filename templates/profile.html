<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SubjectHelper - Профиль</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='back.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <header>
    <a href="/"><img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Логотип"></a>
    {{ menu | safe }}
  </header>

  <main class="profile-container">
    <div class="avatar-wrapper">
      <img
        id="avatar-preview"
        src="{{ current_user.avatar or url_for('static', filename='img/default_avatar.png') }}"
        alt="Аватар"
        class="avatar-large">

      <!-- форма для аватарки -->
      <form method="POST" enctype="multipart/form-data" action="/update_avatar">
        <input type="file" name="avatar" accept="image/*" id="avatarInput" style="display:none;">
        <label for="avatarInput" class="avatar-edit-btn material-icons" title="Изменить аватар">photo_camera</label>
      </form>
    </div>

    <h2>Привет, {{ current_user.name or "Пользователь" }}!</h2>

    <!-- форма для ника -->
    <form method="POST" action="/update_nickname" class="nickname-form">
      <input type="text" name="nickname" class="nickname-input" placeholder="Новый ник (до 20 символов)" maxlength="20">
      <button type="submit" class="nickname-btn">Сохранить</button>
    </form>

    <div class="stats">
      <div class="stat-box">
        <div class="stat-value">{{ total_queries }}</div>
        <div class="stat-label">Всего запросов</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ "%.1f"|format(avg_rating) }}</div>
        <div class="stat-label">Средняя оценка</div>
      </div>
      <div class="stat-box">
        <div class="stat-value">{{ top_subject }}</div>
        <div class="stat-label">Любимый предмет</div>
      </div>
    </div>

    <a href="/chat" class="back-link">← Назад в чат</a>
  </main>

  {{ menu_js | safe }}

  <!-- Предпросмотр аватарки -->
  <script>
  const avatarInput = document.getElementById('avatarInput');
  const avatarPreview = document.getElementById('avatar-preview');

  avatarInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              avatarPreview.src = e.target.result;
          }
          reader.readAsDataURL(file);
          this.form.submit(); // сразу отправляем форму после выбора
      }
  });
  </script>
</body>
</html>