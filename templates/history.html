<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò—Å—Ç–æ—Ä–∏—è ‚Äî SubjectHelper</title>
  <link rel="stylesheet" href="/static/back.css">
  <link rel="stylesheet" href="/static/history.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="{% if session.get('theme') == 'dark' %}dark-theme{% else %}light-theme{% endif %}">
  <header>
    <a href="/"><img class="logo" src="/static/img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"></a>
    <div class="user-menu">
      <div class="user-circle" id="userCircle">{{ current_user.name[0]|upper if current_user.name else 'U' }}</div>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="{{ url_for('profile') }}">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="{{ url_for('history_page') }}">–ò—Å—Ç–æ—Ä–∏—è</a>
        <a href="{{ url_for('logout') }}">–í—ã–π—Ç–∏</a>
      </div>
    </div>
  </header>

  <main class="history-main">
    <div class="history-container">

      <h1>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h1>

      <!-- === –§–ò–õ–¨–¢–†–´ === -->
      <div class="filters">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤–æ–ø—Ä–æ—Å—É..." onkeyup="filterHistory()">
        <select id="subjectFilter" onchange="filterHistory()">
          <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
          <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
          <option value="–§–∏–∑–∏–∫–∞">üî¨ –§–∏–∑–∏–∫–∞</option>
          <option value="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫">üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
          <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">üíª –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
          <option value="–•–∏–º–∏—è">‚öóÔ∏è –•–∏–º–∏—è</option>
          <option value="–ë–∏–æ–ª–æ–≥–∏—è">üß¨ –ë–∏–æ–ª–æ–≥–∏—è</option>
          <option value="–ò—Å—Ç–æ—Ä–∏—è">üìú –ò—Å—Ç–æ—Ä–∏—è</option>
          <option value="–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ">‚öñÔ∏è –û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ</option>
          <option value="–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫">üåç –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
          <d class="subject-card" data-subject="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</d>
          <div class="subject-card" data-subject="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫">üìù –†—É—Å—Å–∫–∏–π —è–∑—ã–∫</div>
          <div class="subject-card" data-subject="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">üíª –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</div>
          <div class="subject-card" data-subject="–§–∏–∑–∏–∫–∞">üî¨ –§–∏–∑–∏–∫–∞</div>
          <div class="subject-card" data-subject="–•–∏–º–∏—è">‚öóÔ∏è –•–∏–º–∏—è</div>
          <div class="subject-card" data-subject="–ë–∏–æ–ª–æ–≥–∏—è">üß¨ –ë–∏–æ–ª–æ–≥–∏—è</div>
          <div class="subject-card" data-subject="–ò—Å—Ç–æ—Ä–∏—è">üìú –ò—Å—Ç–æ—Ä–∏—è</div>
          <div class="subject-card" data-subject="–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ">‚öñÔ∏è –û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ</div>
          <div class="subject-card" data-subject="–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫">üåç –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</div>

        </select>
        <button onclick="exportToPDF()" class="export-btn">
          <span class="material-icons">download</span> PDF
        </button>
      </div>

      <!-- === –°–ü–ò–°–û–ö –ò–°–¢–û–†–ò–ò === -->
      <div id="historyList" class="history-list">
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
      </div>

      <!-- === –ü–ê–ì–ò–ù–ê–¶–ò–Ø === -->
      <div class="pagination" id="pagination">
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
      </div>

      <!-- === –ü–£–°–¢–û === -->
      <div id="emptyState" class="empty-state" style="display: none;">
        <span class="material-icons">history</span>
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ó–∞–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å!</p>
        <a href="/chat" class="btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç</a>
      </div>

    </div>
  </main>

  <script>
    let historyData = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // === –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò ===
    async function loadHistory() {
      try {
        const res = await fetch("/api/history", {
          method: "POST",
          credentials: "include"
        });
        const data = await res.json();
        if (res.ok) {
          historyData = data;
          renderHistory();
        } else {
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏");
        }
      } catch (err) {
        console.error(err);
      }
    }

    // === –†–ï–ù–î–ï–† –ò–°–¢–û–†–ò–ò ===
    function renderHistory() {
      const list = document.getElementById("historyList");
      const empty = document.getElementById("emptyState");
      const filtered = filterData();

      if (filtered.length === 0) {
        list.innerHTML = "";
        empty.style.display = "block";
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      empty.style.display = "none";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filtered.slice(start, end);

      list.innerHTML = pageItems.map(item => `
        <div class="history-item">
          <div class="item-header">
            <span class="subject-badge">${item.subject}</span>
            <span class="mode">${getModeText(item.mode)}</span>
            <span class="timestamp">${formatDate(item.timestamp)}</span>
          </div>
          <div class="item-question">
            <strong>–í–æ–ø—Ä–æ—Å:</strong> ${escapeHtml(item.question)}
          </div>
          <div class="item-answer">
            <strong>–û—Ç–≤–µ—Ç:</strong> ${escapeHtml(item.answer)}
          </div>
          <div class="item-rating">
            ${item.rating ? `${'‚òÖ'.repeat(item.rating)}${'‚òÜ'.repeat(5 - item.rating)}` : '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏'}
          </div>
        </div>
      `).join('');

      renderPagination(filtered.length);
    }

    // === –§–ò–õ–¨–¢–†–ê–¶–ò–Ø ===
    function filterData() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const subject = document.getElementById("subjectFilter").value;

      return historyData.filter(item => {
        const matchesSearch = item.question.toLowerCase().includes(search) || item.answer.toLowerCase().includes(search);
        const matchesSubject = !subject || item.subject === subject;
        return matchesSearch && matchesSubject;
      });
    }

    function filterHistory() {
      currentPage = 1;
      renderHistory();
    }

    // === –ü–ê–ì–ò–ù–ê–¶–ò–Ø ===
    function renderPagination(totalItems) {
      const pages = Math.ceil(totalItems / itemsPerPage);
      const pagination = document.getElementById("pagination");
      if (pages <= 1) {
        pagination.innerHTML = "";
        return;
      }

      let html = "";
      for (let i = 1; i <= pages; i++) {
        html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
      }
      pagination.innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      renderHistory();
    }

    // === –£–¢–ò–õ–ò–¢–´ ===
    function getModeText(mode) {
      const map = { explain: "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ", step: "–†–µ—à–µ–Ω–∏–µ", quiz: "–ü—Ä–æ–≤–µ—Ä–∫–∞", exam: "–≠–∫–∑–∞–º–µ–Ω" };
      return map[mode] || mode;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === –≠–ö–°–ü–û–†–¢ –í PDF ===
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî SubjectHelper", 105, y, { align: "center" });
      y += 15;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);

      const filtered = filterData();
      filtered.forEach((item, idx) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.setFont("helvetica", "bold");
        doc.text(`${idx + 1}. ${item.subject} | ${getModeText(item.mode)} | ${formatDate(item.timestamp)}`, 10, y);
        y += 8;
        doc.setFont("helvetica", "normal");
        doc.text(`Q: ${item.question.substring(0, 200)}${item.question.length > 200 ? '...' : ''}`, 15, y);
        y += 8;
        doc.text(`A: ${item.answer.substring(0, 300)}${item.answer.length > 300 ? '...' : ''}`, 15, y);
        y += 12;
      });

      doc.save("subjecthelper_history.pdf");
    }

    // === –ú–ï–ù–Æ ===
    document.addEventListener("DOMContentLoaded", () => {
      loadHistory();
      const circle = document.getElementById("userCircle");
      const menu = document.getElementById("dropdownMenu");
      if (circle) {
        circle.addEventListener("click", e => {
          e.stopPropagation();
          menu.style.display = menu.style.display === "block" ? "none" : "block";
        });
      }
      document.addEventListener("click", () => { if (menu) menu.style.display = "none"; });
    });
  </script>

  <!-- jsPDF –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>